default:
  # List of environment variables applied to all components
  env:
    - name: OTEL_SERVICE_NAME
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: "metadata.labels['app.kubernetes.io/component']"
    - name: OTEL_COLLECTOR_NAME
      value: '{{ include "otel-demo.name" . }}-otelcol'
    - name: OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE
      value: cumulative
    - name: OTEL_RESOURCE_ATTRIBUTES
      value: 'service.name=$(OTEL_SERVICE_NAME),service.namespace=sherif-k8s-otel-o11y,service.version={{ .Chart.AppVersion }}'

opentelemetry-collector:
  enabled: true
  image:
    repository: "otel/opentelemetry-collector-contrib"
  fullnameOverride: otel-collector
  mode: daemonset
  presets:
    hostMetrics:
      enabled: true
    kubernetesAttributes:
      enabled: true
    kubeletMetrics:
      enabled: true
    clusterMetrics:
      enabled: true
    annotationDiscovery:
      metrics:
        enabled: true
  resources:
    limits:
      memory: 200Mi
  service:
    enabled: true
  ports:
    metrics:
      enabled: true
  config:
    receivers:
      otlp:
        protocols:
          http:
            # Since this collector needs to receive data from the web, enable cors for all origins
            # `allowed_origins` can be refined for your deployment domain
            cors:
              allowed_origins:
                - "http://*"
                - "https://*"

    exporters:
      # Dynatrace OTel Collectors
      otlphttp/dttraces:
        endpoint: http://dynatrace-traces-collector.dynatrace.svc.cluster.local:4318
      otlphttp/dtlogs:
        endpoint: http://dynatrace-logs-collector.dynatrace.svc.cluster.local:4318
      otlphttp/dtmetrics:
        endpoint: http://dynatrace-metrics-cluster-collector.dynatrace.svc.cluster.local:4318
      ## Create an exporter to Jaeger using the standard `otlp` export format
      otlp/jaeger:
        endpoint: jaeger:4317
        tls:
          insecure: true
        sending_queue:
          batch:
      otlphttp/prometheus:
        endpoint: http://prometheus:9090/api/v1/otlp
        tls:
          insecure: true
        sending_queue:
          batch:
      opensearch:
        logs_index: otel-logs
        logs_index_time_format: "yyyy-MM-dd"
        http:
          endpoint: http://opensearch:9200
          tls:
            insecure: true

    processors:
      memory_limiter:
        check_interval: 5s
        limit_percentage: 80
        spike_limit_percentage: 25
      resourcedetection:
        detectors: [env, system]
      # This processor is used to help limit high cardinality on next.js span names
      # When this PR is merged (and released) we can remove this transform processor
      # https://github.com/vercel/next.js/pull/64852
      transform:
        error_mode: ignore
        trace_statements:
          - context: span
            statements:
              # could be removed when https://github.com/vercel/next.js/pull/64852 is fixed upstream
              - replace_pattern(name, "\\?.*", "")
              - replace_match(name, "GET /api/products/*", "GET /api/products/{productId}")
      resource:
        attributes:
        - key: service.instance.id
          from_attribute: k8s.pod.uid
          action: insert

    connectors:
      spanmetrics: {}

    service:
      pipelines:
        traces:
          processors: [memory_limiter, resourcedetection, resource, transform, batch]
          exporters: [otlp/jaeger, debug, spanmetrics,otlphttp/dttraces]
        metrics:
          receivers: [otlp, spanmetrics]
          processors: [memory_limiter, resourcedetection, resource, batch]
          exporters: [otlphttp/prometheus, debug,otlphttp/dtmetrics]
        logs:
          processors: [memory_limiter, resourcedetection, resource, batch]
          exporters: [opensearch, debug,otlphttp/dtlogs]
      telemetry:
        metrics:
          level: detailed
          readers:
            - periodic:
                interval: 10000
                timeout: 5000
                exporter:
                  otlp:
                    protocol: http/protobuf
                    endpoint: http://otel-collector:4318
                    insecure: true

